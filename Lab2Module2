const int wheel = 2;

int wheelCount = 0;
int previousVal = 1;
int val = 0;
int forward = 0;
int backward = 1;
int turn90 = 2;
int count = 0;

//initialize time
  int volatile time1 = 0;
  int volatile time2 = 0;

//initialize desired velocity
  int desiredVelocity = 128;
  int speedleft = 0;
  int speedright = 0;

void setup() {

  //initialize pins
  //E1
  pinMode(6, OUTPUT);
  //M1
  pinMode(7, OUTPUT);
  //E2
  pinMode(5, OUTPUT);
  //M2
  pinMode(4, OUTPUT);
  
  //pin assignment for wheel encoders
  pinMode(2, OUTPUT);
  pinMode(3, OUTPUT);

  attachInterrupt(digitalPinToInterrupt(2), readspeed1, CHANGE);
  attachInterrupt(digitalPinToInterrupt(3), readspeed2, CHANGE);
  
  Serial.begin(9600);
}

void loop() {

 //initialize wheel as input
    pinMode(wheel,OUTPUT);
  
  val=countEncoder();
  Serial.println(val);
  //if moving forwards
  while (val<48)
  {
    digitalWrite(7, HIGH);
    digitalWrite(4, HIGH);                                       
    analogWrite(6, desiredVelocity);                                   
    analogWrite(5, desiredVelocity);

    Serial.println("Hello");
    delay(200);


  if(speedleft!=desiredVelocity)
  {
    increment ();
  }

    //get value of count again
    val = countEncoder();

    //Serial.println(val);

  }

}

int countEncoder(){
  while(1){
    if(digitalRead(2)==HIGH)
    {

      Serial.println("hello");
      while(1)
      {
        if (digitalRead(2)==LOW)
        {
          break;
        }
      }
      wheelCount++;

            Serial.println("wheelcount is"+wheelCount);

      return wheelCount++;
    }
  }
}

  //calculate speed of motor 1
  int readspeed1()
  {
    time2 = millis();
    float t = time2 - time1; //calculate time
    float d = 16;//calculate distance
    float speedleft = d/t;//calculate speed
    Serial.print("Speed of motor 1 is: ");
    Serial.println(speedleft);
    time1 = millis();

    
    return (speedleft);
  }
  //calculate speed of motor 2
    int readspeed2()
  {
    time2 = millis();
    float t = time2 - time1; //calculate time
    float d = 16 ;//calculate distance
    float speedright = d/t; //calculate speed

    Serial.print("Speed of motor 2 is: ");
    Serial.println(speedright);

    time1 = millis();
    return (speedright);
    }

//Compare actual speed to desired speed 
void increment ()
{
int leftSpeedInc = 0.5*round(32*(desiredVelocity-speedleft));
int leftSpeedValue = speedleft + leftSpeedInc;
analogWrite(5, leftSpeedValue); 

int rightSpeedInc = 0.5*round(32*(desiredVelocity-speedright));
int rightSpeedValue = speedright + rightSpeedInc;
analogWrite(5, rightSpeedValue); 

Serial.println("left speed value is: ");
Serial.println(leftSpeedValue);
delay(100);
}
